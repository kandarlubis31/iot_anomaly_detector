<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Anomali IoT - Enhanced</title>
    <!-- Memuat Chart.js dan adapter tanggal -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-display:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .message-box {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .message-box.info {
            background: #d1ecf1;
            border-left: 4px solid #0dcaf0;
            color: #0c5460;
        }

        .message-box.success {
            background: #d1e7dd;
            border-left: 4px solid #198754;
            color: #0f5132;
        }

        .message-box.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            color: #6c757d;
            font-size: 1.1em;
            font-weight: 500;
        }

        .stat-card.anomaly h3 {
            color: #dc3545;
        }

        .stat-card.normal h3 {
            color: #28a745;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .chart-container.large {
            height: 500px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .anomaly-list {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .anomaly-list h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .anomaly-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç IoT Anomaly Detector</h1>
            <p>Advanced anomaly detection for IoT sensor data with interactive visualizations</p>
        </div>

        <div class="main-content">
            <div class="message-box" id="messageBox"></div>

            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" accept=".csv">
                    <div class="file-input-display" id="fileDisplay">
                        <strong>üìÅ Choose CSV File</strong><br>
                        <span style="color: #6c757d;">Click here to select your IoT data file</span>
                    </div>
                </div>
                <button class="upload-btn" onclick="uploadCsv()">üöÄ Analyze Data</button>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Analyzing data... Please wait</p>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalPoints">0</h3>
                        <p>Total Data Points</p>
                    </div>
                    <div class="stat-card anomaly">
                        <h3 id="numAnomalies">0</h3>
                        <p>Anomalies Detected</p>
                    </div>
                    <div class="stat-card normal">
                        <h3 id="normalPoints">0</h3>
                        <p>Normal Points</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="anomalyPercentage">0%</h3>
                        <p>Anomaly Rate</p>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h3>üìä Time Series Analysis</h3>
                        <div class="controls">
                            <div class="control-group">
                                <label for="chartType">Chart Type:</label>
                                <select id="chartType" onchange="updateChart()">
                                    <option value="line">Line Chart</option>
                                    <option value="scatter">Scatter Plot</option>
                                    <option value="both">Combined View</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="dataRange">Data Range:</label>
                                <select id="dataRange" onchange="updateChart()">
                                    <option value="all">All Data</option>
                                    <option value="last100">Last 100 Points</option>
                                    <option value="last50">Last 50 Points</option>
                                    <option value="anomalies">Anomalies Only</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container large">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3>üìà Distribution Analysis</h3>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3>‚ö° Anomaly Score Distribution</h3>
                        <div class="chart-container">
                            <canvas id="scoreChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="anomaly-list" id="anomalyList">
                    <h4>üö® Detected Anomalies</h4>
                    <div id="anomaliesContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mengubah deklarasi dari 'let' menjadi 'var' untuk mengatasi SyntaxError
        var charts = {}; // Objek untuk menyimpan instance Chart.js
        var rawData = null; // Data asli dari backend
        var processedData = null; // Data yang sudah difilter untuk charting

        // Handler untuk menampilkan nama file yang dipilih
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const display = document.getElementById('fileDisplay');
            
            if (file) {
                display.innerHTML = `<strong>üìÑ ${file.name}</strong><br><span style="color: #28a745;">File selected (${(file.size/1024).toFixed(1)} KB)</span>`;
            } else {
                display.innerHTML = '<strong>üìÅ Choose CSV File</strong><br><span style="color: #6c757d;">Click here to select your IoT data file</span>';
            }
        });

        // Fungsi untuk menampilkan pesan ke pengguna
        function showMessage(message, type = 'info') {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = message;
            msgBox.className = `message-box ${type}`;
            msgBox.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    msgBox.style.display = 'none';
                }, 5000); // Pesan sukses akan hilang setelah 5 detik
            }
        }

        // Fungsi untuk menyembunyikan pesan
        function hideMessage() {
            document.getElementById('messageBox').style.display = 'none';
        }

        // Fungsi untuk menampilkan/menyembunyikan spinner loading
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.querySelector('.upload-btn').disabled = show; // Disable tombol saat loading
        }

        // Fungsi utama untuk mengunggah CSV dan mendeteksi anomali
        async function uploadCsv() {
            hideMessage(); // Sembunyikan pesan sebelumnya
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];

            if (!file) {
                showMessage("Harap pilih file CSV terlebih dahulu.", 'error');
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', file);

            showLoading(true); // Tampilkan spinner loading
            document.getElementById('resultsSection').style.display = 'none'; // Sembunyikan hasil sebelumnya

            try {
                // Lakukan panggilan fetch ke backend Flask
                const response = await fetch('/upload_csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json(); // Parse respons JSON dari backend

                if (response.ok) { // Jika respons HTTP 200 OK
                    showMessage("Deteksi anomali berhasil!", 'success');
                    
                    // Simpan data mentah dari backend
                    rawData = result.chart_data; 
                    
                    // Perbarui statistik ringkasan
                    updateSummaryStats(result);

                    // Buat dan tampilkan semua grafik
                    updateChartsAndList(rawData);
                    document.getElementById('resultsSection').style.display = 'block';

                } else { // Jika respons HTTP bukan 200 OK (misal 400, 500)
                    showMessage(`Error: ${result.error || response.statusText}`, 'error');
                    console.error('Backend Error:', result.error || response.statusText);
                }

            } catch (error) { // Jika terjadi kesalahan jaringan atau lainnya
                showMessage("Terjadi kesalahan saat berkomunikasi dengan server. Pastikan server Flask berjalan.", 'error');
                console.error('Fetch Error:', error);
            } finally {
                showLoading(false); // Sembunyikan spinner loading
            }
        }

        // Fungsi untuk memperbarui statistik ringkasan
        function updateSummaryStats(result) {
            const totalPoints = result.total_points;
            const numAnomalies = result.num_anomalies;
            const normalPoints = totalPoints - numAnomalies;
            const anomalyPercentage = result.anomaly_percentage;

            document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
            document.getElementById('numAnomalies').textContent = numAnomalies.toLocaleString();
            document.getElementById('normalPoints').textContent = normalPoints.toLocaleString();
            document.getElementById('anomalyPercentage').textContent = anomalyPercentage + '%';
        }

        // Fungsi untuk memperbarui semua grafik dan daftar anomali
        function updateChartsAndList(data) {
            processedData = data; // Gunakan data asli dari backend sebagai processedData awal
            
            // Panggil fungsi chart utama untuk render awal (dengan filter default 'all')
            createMainChart(processedData); 
            createDistributionChart(processedData);
            createScoreChart(processedData);
            createAnomalyList(processedData);
        }

        // Fungsi yang dipanggil saat dropdown Chart Type atau Data Range berubah
        function updateChart() {
            if (rawData) { // Pastikan ada data untuk diupdate
                // Filter data berdasarkan range yang dipilih oleh user
                processedData = filterDataByRange(rawData, document.getElementById('dataRange').value);
                createMainChart(processedData); // Render ulang chart utama dengan data filter
            } else {
                showMessage("Tidak ada data untuk diperbarui. Unggah file CSV terlebih dahulu.", 'info');
            }
        }

        // Fungsi untuk membuat Chart Utama (Time Series)
        function createMainChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (charts.main) {
                charts.main.destroy(); // Hancurkan chart lama jika ada
            }

            const datasets = [];
            const chartType = document.getElementById('chartType').value;
            
            // Konversi timestamps ke format Date objek
            const timestampsParsed = data.timestamps.map(ts => new Date(ts));

            // Pisahkan data normal dan anomali untuk charting
            const normalDataPoints = timestampsParsed.map((timestamp, index) => ({
                x: timestamp,
                y: data.temperatures[index],
                y2: data.power_consumptions[index]
            })).filter((_, index) => !data.is_anomaly[index]);

            const anomalyDataPoints = timestampsParsed.map((timestamp, index) => ({
                x: timestamp,
                y: data.temperatures[index],
                y2: data.power_consumptions[index],
                score: data.anomaly_scores[index] // Tambahkan skor anomali untuk tooltip
            })).filter((_, index) => data.is_anomaly[index]);


            if (chartType === 'line' || chartType === 'both') {
                datasets.push({
                    label: 'Suhu (Normal)',
                    data: normalDataPoints.map(d => ({x: d.x, y: d.y})),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 2,
                    type: 'line' // Eksplisit sebagai line chart
                });

                datasets.push({
                    label: 'Daya (Normal)',
                    data: normalDataPoints.map(d => ({x: d.x, y: d.y2})),
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 2,
                    yAxisID: 'y1', // Sumbu Y kedua
                    type: 'line' // Eksplisit sebagai line chart
                });
            }

            if (chartType === 'scatter' || chartType === 'both') {
                datasets.push({
                    label: 'Suhu (Anomali)',
                    data: anomalyDataPoints.map(d => ({x: d.x, y: d.y, score: d.score})),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    showLine: false,
                    type: 'scatter' // Tipe scatter untuk poin anomali
                });

                datasets.push({
                    label: 'Daya (Anomali)',
                    data: anomalyDataPoints.map(d => ({x: d.x, y: d.y2, score: d.score})),
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.8)',
                    borderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    showLine: false,
                    type: 'scatter',
                    yAxisID: 'y1' // Sumbu Y kedua
                });
            }

            charts.main = new Chart(ctx, {
                type: 'line', // Tipe default jika tidak ada dataset spesifik
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Menggunakan adapter date-fns untuk format waktu
                                    return Chart.adapters.date.toDate(context[0].parsed.x).toLocaleString();
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                    }
                                    // Tambahkan skor anomali jika dataset adalah anomali
                                    if (context.dataset.label.includes('Anomali') && context.raw.score !== undefined) {
                                        label += ` (Skor: ${context.raw.score.toFixed(3)})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'MMM d, HH:mm' // Perbaikan: 'D' menjadi 'd'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Waktu'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Suhu (¬∞C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Konsumsi Daya (W)'
                            }
                        }
                    }
                }
            });
        }

        // Fungsi untuk membuat Chart Distribusi (Histogram)
        function createDistributionChart(data) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (charts.distribution) {
                charts.distribution.destroy();
            }

            // Gabungkan data suhu dan daya untuk distribusi umum
            const allMeasurements = data.temperatures.concat(data.power_consumptions);
            const bins = createHistogram(allMeasurements, 30); // Lebih banyak bin untuk distribusi umum

            charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.labels,
                    datasets: [{
                        label: 'Distribusi Suhu & Daya',
                        data: bins.counts,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Nilai Pengukuran'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frekuensi'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fungsi untuk membuat Chart Distribusi Skor Anomali
        function createScoreChart(data) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            if (charts.score) {
                charts.score.destroy();
            }

            const scoreBins = createHistogram(data.anomaly_scores, 15);

            charts.score = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scoreBins.labels,
                    datasets: [{
                        label: 'Distribusi Skor Anomali',
                        data: scoreBins.counts,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Skor Anomali'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frekuensi'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fungsi utilitas untuk membuat data histogram
        function createHistogram(data, bins) {
            const min = Math.min(...data);
            const max = Math.max(...data);
            // Handle case where min === max to avoid division by zero
            const binSize = (max === min) ? 1 : (max - min) / bins; 
            
            const counts = new Array(bins).fill(0);
            const labels = [];
            
            for (let i = 0; i < bins; i++) {
                labels.push((min + i * binSize).toFixed(1));
            }
            
            data.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binSize), bins - 1);
                counts[binIndex]++;
            });
            
            return { labels, counts };
        }

        // Fungsi untuk memfilter data berdasarkan rentang yang dipilih
        function filterDataByRange(data, range) {
            let filteredTimestamps = [];
            let filteredTemperatures = [];
            let filteredPowerConsumptions = [];
            let filteredIsAnomaly = [];
            let filteredAnomalyScores = [];

            let startIndex = 0;
            if (range === 'last100') {
                startIndex = Math.max(0, data.timestamps.length - 100);
            } else if (range === 'last50') {
                startIndex = Math.max(0, data.timestamps.length - 50);
            }

            for (let i = startIndex; i < data.timestamps.length; i++) {
                const isAnomaly = data.is_anomaly[i];
                if (range === 'anomalies' && !isAnomaly) {
                    continue; // Skip normal points if 'anomalies only' is selected
                }
                filteredTimestamps.push(data.timestamps[i]);
                filteredTemperatures.push(data.temperatures[i]);
                filteredPowerConsumptions.push(data.power_consumptions[i]);
                filteredIsAnomaly.push(isAnomaly);
                filteredAnomalyScores.push(data.anomaly_scores[i]);
            }
            
            return {
                timestamps: filteredTimestamps,
                temperatures: filteredTemperatures,
                power_consumptions: filteredPowerConsumptions,
                is_anomaly: filteredIsAnomaly,
                anomaly_scores: filteredAnomalyScores
            };
        }


        // Fungsi untuk membuat daftar anomali
        function createAnomalyList(data) {
            const container = document.getElementById('anomaliesContainer');
            container.innerHTML = ''; // Bersihkan konten lama
            
            const anomalies = data.timestamps
                .map((timestamp, index) => ({
                    timestamp: timestamp,
                    temperature: data.temperatures[index],
                    power: data.power_consumptions[index],
                    score: data.anomaly_scores[index],
                    isAnomaly: data.is_anomaly[index]
                }))
                .filter(item => item.isAnomaly) // Hanya anomali
                .sort((a, b) => a.score - b.score) // Urutkan berdasarkan skor anomali (terendah lebih anomali)
                .slice(0, 10); // Tampilkan maksimal 10 anomali teratas

            if (anomalies.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #28a745; font-weight: bold;">Tidak ada anomali terdeteksi! üéâ</p>';
                document.getElementById('anomalyList').style.display = 'block'; // Pastikan bagian daftar anomali tetap terlihat
                return;
            }

            anomalies.forEach(anomaly => {
                const item = document.createElement('div');
                item.className = 'anomaly-item';
                item.innerHTML = `
                    <div>
                        <strong>${new Date(anomaly.timestamp).toLocaleString()}</strong><br>
                        <small>Temp: ${anomaly.temperature.toFixed(1)}¬∞C, Power: ${anomaly.power.toFixed(1)}W</small>
                    </div>
                    <div style="text-align: right;">
                        <span style="color: #dc3545; font-weight: bold;">Skor Anomali: ${anomaly.score.toFixed(3)}</span>
                    </div>
                `;
                container.appendChild(item);
            });
            document.getElementById('anomalyList').style.display = 'block';
        }

        // Inisialisasi tampilan awal
        document.addEventListener('DOMContentLoaded', () => {
            // Sembunyikan hasil dan loading spinner di awal
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('anomalyList').style.display = 'none';
        });
    </script>
</body>
</html>
